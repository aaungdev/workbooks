import requests
from requests.auth import HTTPBasicAuth
import certifi
import pandas as pd

# ---- 1. CONFIGURATION ----
jira_url = "https://your-domain.atlassian.net"  # 🔁 Replace with your Jira URL
email = "your-email@example.com"                # 🔁 Replace with your Jira email
api_token = "your-api-token"                    # 🔁 Replace with your Jira API token

# JQL to filter issues
jql = "project = DEMO ORDER BY created DESC"    # 🔁 Change to your project key or custom JQL

# Endpoint
url = f"{jira_url}/rest/api/3/search"

# Headers
headers = {
    "Accept": "application/json",
    "Content-Type": "application/json"
}

# Parameters
query = {
    'jql': jql,
    'maxResults': 50,
    'fields': 'summary,status,assignee,created,updated'
}

# ---- 2. MAKE REQUEST ----
response = requests.get(
    url,
    headers=headers,
    params=query,
    auth=HTTPBasicAuth(email, api_token),
    verify=certifi.where()  # ✅ Secure SSL verification
)

# ---- 3. HANDLE RESPONSE ----
if response.status_code == 200:
    data = response.json()
    issues = data['issues']
    
    # Extract relevant fields
    records = []
    for issue in issues:
        fields = issue['fields']
        records.append({
            'Key': issue['key'],
            'Summary': fields['summary'],
            'Status': fields['status']['name'],
            'Assignee': fields['assignee']['displayName'] if fields['assignee'] else 'Unassigned',
            'Created': fields['created'],
            'Updated': fields['updated']
        })
    
    # ---- 4. EXPORT TO EXCEL ----
    df = pd.DataFrame(records)
    df.to_excel("jira_issues.xlsx", index=False)
    print("✅ Jira issues exported to 'jira_issues.xlsx'")
else:
    print(f"❌ Failed to fetch issues: {response.status_code}")
    print(response.text)